<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reddit OAuth Callback</title>
    <style>
      html, body { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
      .wrap { height: 100%; display: grid; place-items: center; background: #0b0b0c; color: #e5e7eb; }
      .card { padding: 20px 24px; border-radius: 12px; background: #111113; box-shadow: 0 10px 30px rgba(0,0,0,.35); min-width: 320px; text-align: center; }
      .muted { color: #9ca3af; font-size: 12px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div id="status">Finalizing Reddit authorization…</div>
        <div class="muted" id="hint">Please wait. You can close this window after completion.</div>
      </div>
    </div>

    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const state = params.get('state');

        function notify(opOk) {
          try {
            if (window.opener && !window.opener.closed) {
              window.opener.postMessage({ type: 'reddit_oauth_done', ok: !!opOk }, '*');
              window.close();
              return;
            }
          } catch (_) {}
          // Fallback: redirect back to the app
          window.location.replace('/social-accounts' + (opOk ? '?oauth=ok' : '?oauth=failed'));
        }

        function setStatus(text) {
          var el = document.getElementById('status');
          if (el) el.textContent = text;
        }

        if (!code || !state) {
          setStatus('Missing authorization code or state.');
          return notify(false);
        }

        try {
          // Prefer localStorage so the popup can access credentials set in the main window
          var authRaw = localStorage.getItem('adtask_auth') || sessionStorage.getItem('adtask_auth');
          if (!authRaw) throw new Error('Missing credentials in storage');
          var parsed = {};
          try { parsed = JSON.parse(authRaw); } catch (_) {}

          var authorization = '';
          if (parsed && parsed.mode === 'bearer' && parsed.token) {
            authorization = 'Bearer ' + parsed.token;
          } else if (parsed && parsed.username && parsed.password) {
            authorization = 'Basic ' + btoa(parsed.username + ':' + parsed.password);
          }
          if (!authorization) throw new Error('Invalid or missing credentials');

          setStatus('Linking Reddit account…');
          fetch('/api/adtask/api/reddit-oauth/callback', {
            method: 'POST',
            headers: {
              'content-type': 'application/json',
              'authorization': authorization
            },
            body: JSON.stringify({
              code: code,
              state: state,
              redirect_uri: window.location.origin + '/social-accounts/reddit-callback.html'
            })
          })
          .then(function (resp) { return resp.ok ? resp.text() : resp.text().then(function(t){ throw new Error(t || ('HTTP ' + resp.status)); }); })
          .then(function () { notify(true); })
          .catch(function (err) {
            console.error('Reddit callback failed:', err);
            setStatus('Authorization failed.');
            notify(false);
          });
        } catch (e) {
          console.error('Callback error:', e);
          setStatus('Authorization failed.');
          notify(false);
        }
      })();
    </script>
  </body>
  </html>
